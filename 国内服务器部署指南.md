# 国内服务器部署指南（中国区用户访问）

## 一、服务器选择

### 推荐云服务商（国内）

1. **阿里云**（推荐）
   - 网址：https://www.aliyun.com
   - 优势：稳定、速度快、备案方便
   - 推荐配置：2核4G，带宽5Mbps起
   - 价格：约200-500元/月

2. **腾讯云**
   - 网址：https://cloud.tencent.com
   - 优势：性价比高、与微信生态集成好
   - 推荐配置：2核4G，带宽5Mbps起
   - 价格：约150-400元/月

3. **华为云**
   - 网址：https://www.huaweicloud.com
   - 优势：企业级服务、安全性高
   - 推荐配置：2核4G，带宽5Mbps起

### 服务器配置建议

**最低配置**（个人/小团队使用）：
- CPU：2核
- 内存：4GB
- 硬盘：40GB SSD
- 带宽：5Mbps
- 系统：Ubuntu 20.04 LTS 或 CentOS 7

**推荐配置**（多人使用）：
- CPU：4核
- 内存：8GB
- 硬盘：80GB SSD
- 带宽：10Mbps
- 系统：Ubuntu 22.04 LTS

---

## 二、域名准备（可选但推荐）

### 域名购买

1. **阿里云域名**
   - 网址：https://wanwang.aliyun.com
   - 价格：.com约55元/年，.cn约29元/年

2. **腾讯云域名**
   - 网址：https://dnspod.cloud.tencent.com
   - 价格：.com约55元/年，.cn约29元/年

### 域名备案（重要！）

**如果使用国内服务器，必须备案域名才能访问**

#### 备案流程（以阿里云为例）

1. **准备材料**：
   - 身份证正反面照片
   - 域名证书
   - 备案申请表

2. **备案步骤**：
   - 登录阿里云控制台
   - 进入"备案"页面
   - 填写备案信息
   - 上传材料
   - 等待审核（通常7-20个工作日）

3. **备案注意事项**：
   - 个人备案：需要个人身份证
   - 企业备案：需要营业执照
   - 备案期间域名无法访问
   - 备案通过后才能正常使用

**如果不想备案**：
- 使用香港服务器（无需备案，但速度稍慢）
- 使用国外服务器（无需备案，但可能被墙）

---

## 三、详细部署步骤

### 步骤1：购买服务器

1. 登录云服务商控制台
2. 选择"云服务器ECS"或"轻量应用服务器"
3. 选择配置和地域（建议选择离用户近的地域）
4. 选择Ubuntu 20.04系统镜像
5. 设置root密码或SSH密钥
6. 购买并启动服务器

### 步骤2：连接服务器

**Windows用户使用PuTTY或Windows Terminal**：

```bash
# 使用SSH连接
ssh root@your-server-ip

# 输入密码后登录
```

**获取服务器IP**：
- 在云控制台的"实例列表"中查看
- 公网IP就是访问地址

### 步骤3：初始化服务器环境

```bash
# 更新系统
apt update && apt upgrade -y

# 安装必要工具
apt install -y git curl wget vim

# 安装Python 3.10
apt install -y python3.10 python3.10-venv python3-pip

# 验证Python版本
python3 --version
```

### 步骤4：上传项目文件

**方法1：使用Git（推荐）**

```bash
# 安装Git
apt install -y git

# 克隆项目（如果项目在GitHub/Gitee）
cd /opt
git clone your-repo-url pdf-to-ppt-manual
cd pdf-to-ppt-manual
```

**方法2：使用SCP上传**

在本地Windows PowerShell中：

```powershell
# 上传整个文件夹
scp -r pdf-to-ppt-manual root@your-server-ip:/opt/
```

**方法3：使用FTP工具**

- 使用FileZilla等FTP工具上传文件

### 步骤5：安装项目依赖

```bash
cd /opt/pdf-to-ppt-manual

# 创建虚拟环境（推荐）
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 安装PyMuPDF（推荐，无需poppler）
pip install PyMuPDF

# 或安装poppler（如果使用pdf2image）
apt install -y poppler-utils
```

### 步骤6：配置应用

```bash
# 创建必要的目录
mkdir -p uploads temp output

# 设置权限
chmod 755 uploads temp output
chown -R www-data:www-data uploads temp output
```

### 步骤7：安装并配置Gunicorn

```bash
# 安装Gunicorn
pip install gunicorn

# 测试运行
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### 步骤8：创建Systemd服务

创建服务文件：

```bash
vim /etc/systemd/system/pdf-to-ppt.service
```

内容如下：

```ini
[Unit]
Description=PDF习题拆分PPT工具
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/pdf-to-ppt-manual
Environment="PATH=/opt/pdf-to-ppt-manual/venv/bin:/usr/bin:/usr/local/bin"
ExecStart=/opt/pdf-to-ppt-manual/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 --timeout 120 app:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
# 重载systemd
systemctl daemon-reload

# 启动服务
systemctl start pdf-to-ppt

# 设置开机自启
systemctl enable pdf-to-ppt

# 查看状态
systemctl status pdf-to-ppt
```

### 步骤9：安装并配置Nginx

```bash
# 安装Nginx
apt install -y nginx

# 创建Nginx配置
vim /etc/nginx/sites-available/pdf-to-ppt
```

配置内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名，或使用服务器IP

    # 日志
    access_log /var/log/nginx/pdf-to-ppt-access.log;
    error_log /var/log/nginx/pdf-to-ppt-error.log;

    # 上传文件大小限制（50MB）
    client_max_body_size 50M;

    # 静态文件
    location /static {
        alias /opt/pdf-to-ppt-manual/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 代理到Flask应用
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

启用配置：

```bash
# 创建软链接
ln -s /etc/nginx/sites-available/pdf-to-ppt /etc/nginx/sites-enabled/

# 删除默认配置（可选）
rm /etc/nginx/sites-enabled/default

# 测试配置
nginx -t

# 重启Nginx
systemctl restart nginx
```

### 步骤10：配置防火墙

```bash
# 安装ufw（如果未安装）
apt install -y ufw

# 允许SSH（重要！先配置这个）
ufw allow 22/tcp

# 允许HTTP和HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# 启用防火墙
ufw enable

# 查看状态
ufw status
```

### 步骤11：配置SSL证书（HTTPS）

**使用Let's Encrypt免费证书**：

```bash
# 安装Certbot
apt install -y certbot python3-certbot-nginx

# 获取证书（需要域名已解析）
certbot --nginx -d your-domain.com

# 自动续期测试
certbot renew --dry-run
```

**配置自动续期**：

```bash
# 编辑crontab
crontab -e

# 添加以下行（每月1号凌晨3点续期）
0 3 1 * * certbot renew --quiet
```

---

## 四、域名解析配置

### 在域名服务商处配置DNS

1. **登录域名控制台**（阿里云/腾讯云）

2. **添加A记录**：
   - 记录类型：A
   - 主机记录：@（或www）
   - 记录值：服务器公网IP
   - TTL：600（10分钟）

3. **等待DNS生效**（通常5-30分钟）

4. **验证解析**：
   ```bash
   # 在本地命令行执行
   ping your-domain.com
   # 或
   nslookup your-domain.com
   ```

---

## 五、访问测试

### 测试步骤

1. **测试HTTP访问**：
   ```
   http://your-server-ip
   或
   http://your-domain.com
   ```

2. **测试HTTPS访问**（配置SSL后）：
   ```
   https://your-domain.com
   ```

3. **测试功能**：
   - 上传PDF文件
   - 选择题目
   - 生成PPT
   - 下载PPT

---

## 六、性能优化

### 1. 启用Gzip压缩

编辑Nginx配置：

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
```

### 2. 配置缓存

```nginx
# 静态文件缓存
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

### 3. 限制并发连接

```nginx
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s;

server {
    limit_conn conn_limit_per_ip 20;
    limit_req zone=req_limit_per_ip burst=20 nodelay;
    # ... 其他配置
}
```

---

## 七、监控和维护

### 1. 查看日志

```bash
# 应用日志
journalctl -u pdf-to-ppt -f

# Nginx访问日志
tail -f /var/log/nginx/pdf-to-ppt-access.log

# Nginx错误日志
tail -f /var/log/nginx/pdf-to-ppt-error.log
```

### 2. 定期清理临时文件

创建清理脚本 `/opt/pdf-to-ppt-manual/cleanup.sh`：

```bash
#!/bin/bash
# 清理7天前的临时文件
find /opt/pdf-to-ppt-manual/temp -type f -mtime +7 -delete
find /opt/pdf-to-ppt-manual/output -type f -mtime +7 -delete
```

添加到crontab：

```bash
crontab -e
# 每天凌晨2点清理
0 2 * * * /opt/pdf-to-ppt-manual/cleanup.sh
```

### 3. 监控服务状态

```bash
# 检查服务状态
systemctl status pdf-to-ppt
systemctl status nginx

# 检查端口占用
netstat -tlnp | grep 5000
netstat -tlnp | grep 80
```

---

## 八、常见问题解决

### 1. 无法访问

**检查项**：
- 防火墙是否开放80/443端口
- Nginx是否正常运行
- Flask应用是否正常运行
- 域名是否已解析

**排查命令**：
```bash
# 检查服务状态
systemctl status pdf-to-ppt
systemctl status nginx

# 检查端口
netstat -tlnp | grep 5000
netstat -tlnp | grep 80

# 检查防火墙
ufw status
```

### 2. 上传文件失败

**检查项**：
- Nginx的`client_max_body_size`配置
- 目录权限是否正确
- 磁盘空间是否充足

### 3. 性能问题

**优化建议**：
- 增加Gunicorn worker数量
- 启用Gzip压缩
- 使用CDN加速静态文件
- 升级服务器配置

---

## 九、成本估算

### 月度成本（参考）

1. **服务器**：200-500元/月
2. **域名**：约5元/月（年付55元）
3. **SSL证书**：免费（Let's Encrypt）
4. **备案**：免费

**总计**：约205-505元/月

---

## 十、快速部署脚本

创建一键部署脚本 `deploy.sh`：

```bash
#!/bin/bash
# PDF习题拆分PPT工具 - 一键部署脚本

set -e

echo "=========================================="
echo "PDF习题拆分PPT工具 - 服务器部署"
echo "=========================================="

# 更新系统
echo "更新系统..."
apt update && apt upgrade -y

# 安装基础工具
echo "安装基础工具..."
apt install -y git curl wget vim python3 python3-pip python3-venv nginx ufw

# 安装项目依赖
echo "安装项目依赖..."
cd /opt/pdf-to-ppt-manual
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
pip install PyMuPDF gunicorn

# 创建目录
mkdir -p uploads temp output
chmod 755 uploads temp output

# 配置systemd服务
echo "配置systemd服务..."
cat > /etc/systemd/system/pdf-to-ppt.service <<EOF
[Unit]
Description=PDF习题拆分PPT工具
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/pdf-to-ppt-manual
Environment="PATH=/opt/pdf-to-ppt-manual/venv/bin:/usr/bin:/usr/local/bin"
ExecStart=/opt/pdf-to-ppt-manual/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 --timeout 120 app:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
systemctl daemon-reload
systemctl enable pdf-to-ppt
systemctl start pdf-to-ppt

# 配置防火墙
echo "配置防火墙..."
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

echo "=========================================="
echo "部署完成！"
echo "=========================================="
echo "请配置Nginx和域名解析"
echo "访问地址：http://your-server-ip"
```

---

## 十一、访问地址示例

部署完成后，你的应用可以通过以下方式访问：

1. **使用IP访问**（临时）：
   ```
   http://123.456.789.012
   ```

2. **使用域名访问**（推荐）：
   ```
   http://pdf-to-ppt.yourdomain.com
   或
   https://pdf-to-ppt.yourdomain.com（配置SSL后）
   ```

---

## 十二、安全建议

1. **修改SSH端口**（避免使用22端口）
2. **禁用root登录**，使用普通用户+sudo
3. **配置fail2ban**防止暴力破解
4. **定期更新系统**和软件
5. **配置防火墙**规则
6. **使用HTTPS**加密传输
7. **定期备份**数据

---

## 需要帮助？

如果在部署过程中遇到问题，可以：
1. 查看日志文件排查问题
2. 检查服务状态
3. 参考云服务商的文档
4. 联系云服务商技术支持

